#!/bin/sh

current_branch=$(git branch --show-current)

# Check if behind main (skip if on main)
if [ "$current_branch" != "main" ]; then
  git fetch origin main 2>/dev/null
  behind_main=$(git rev-list --count HEAD..origin/main 2>/dev/null || echo "0")

  if [ "$behind_main" -gt 0 ]; then
    cat << EOF

Branch out of sync.

  Your branch "$current_branch" is $behind_main commit(s) behind main.

  To sync:   ./scripts/sync-branch.sh
  To bypass: SKIP_SYNC_CHECK=1 git push

EOF

    [ "${SKIP_SYNC_CHECK:-}" = "1" ] || exit 1
  fi
fi

# Run checks
echo "Running pre-push checks..."
echo ""

echo "[1/4] Lint & types..."
bun run check || { echo "Fix lint/type errors before pushing."; exit 1; }

echo "[2/4] Unit tests..."
bun run test:run || { echo "Fix failing tests before pushing."; exit 1; }

echo "[3/4] E2E tests..."
bun run test:e2e || { echo "Fix failing E2E tests before pushing."; exit 1; }

echo "[4/4] Build..."
bun run build || { echo "Fix build errors before pushing."; exit 1; }

echo ""
echo "All checks passed."
