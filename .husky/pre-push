#!/bin/sh

current_branch=$(git branch --show-current)

# Check if behind main (skip if on main)
if [ "$current_branch" != "main" ]; then
  git fetch origin main 2>/dev/null
  behind_main=$(git rev-list --count HEAD..origin/main 2>/dev/null || echo "0")

  if [ "$behind_main" -gt 0 ]; then
    echo ""
    echo "Branch is $behind_main commit(s) behind main. Syncing..."

    # Check for uncommitted changes
    if ! git diff --quiet || ! git diff --cached --quiet; then
      cat << EOF

Cannot auto-sync: uncommitted changes detected.

  Commit or stash your changes, then run: bun run sync

EOF
      exit 1
    fi

    # Check if branch exists on remote (will need force push after rebase)
    needs_force=false
    if git rev-parse --verify origin/"$current_branch" >/dev/null 2>&1; then
      needs_force=true
    fi

    # Try to rebase
    if git rebase origin/main; then
      echo ""
      echo "Synced successfully."
      
      if [ "$needs_force" = true ]; then
        cat << EOF

Run: git push --force-with-lease

EOF
        exit 1
      fi
      echo ""
    else
      git rebase --abort 2>/dev/null
      cat << EOF

Cannot auto-sync: conflicts detected.

  Run manually:  bun run sync
  To bypass:     SKIP_SYNC_CHECK=1 git push

EOF
      exit 1
    fi
  fi
fi

# Run checks
echo "Running pre-push checks..."
echo ""

echo "[1/3] Lint & types..."
bun run check || { echo "Fix lint/type errors before pushing."; exit 1; }

echo "[2/3] Unit tests..."
bun run test:run || { echo "Fix failing tests before pushing."; exit 1; }

echo "[3/3] E2E tests..."
bun run test:e2e || { echo "Fix failing E2E tests before pushing."; exit 1; }

echo ""
echo "All checks passed."
